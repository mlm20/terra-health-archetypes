# ğŸ§¬ Health Archetypes â€“ Local Demo Spec (LLM + Image Gen Edition)

A fast, privacy-first, no-login web demo where users connect their wearable, get a one-of-a-kind **Health Archetype**, and copy a beautifully generated card to share with friends.

---

## ğŸ§  Overview

**Tagline:**

> A unique health vibe, powered by your real data.

**Core experience:**

1. User connects their wearable (via Terra)
2. AI analyzes their health data
3. A custom archetype + avatar is generated
4. Data is deleted â€” session-based only, no tracking

---

## ğŸ¨ Copy & Tone

**Voice:**

- Playful, creative, non-judgemental
- Inspired by video game classes, MBTI, and personality types
- Avoid clinical terms like "score", "diagnosis", or "medical condition"

**Tone examples:**

- "A snapshot of your fitness energy."
- "You're more than your stats. But here's your style."
- "Your data? Already wiped like a pro cooldown stretch."

---

## ğŸ–¼ï¸ App Flow

### Frame 1: Landing Page

- ğŸ“ Light intro explaining:

  - No login or signup
  - Just one personalized profile
  - Everything is local and deleted after

- ğŸŸ¢ CTA: "Connect Your Wearable" (launches Terra Widget)

---

### Frame 2: Progress Stepper

Stepper shows live feedback through the following phases:

| Step | Label                | Copy                                                   |
| ---- | -------------------- | ------------------------------------------------------ |
| 1    | Device Connected     | "Wearable linked â€” syncing your data flow ğŸ›°ï¸"          |
| 2    | Health Data Obtained | "Cracking open your past workouts, sleep, and vitalsâ€¦" |
| 3    | Archetype Discovered | "Channeling your energy into a one-of-a-kind vibeâ€¦ ğŸ§˜â€â™‚ï¸" |
| 4    | Data Cleared         | "Data deleted. Nothing saved. You're all set ğŸ§¼"       |

---

### Frame 3: Archetype Card

**Displays:**

- ğŸ§  Generated **Archetype Name** and Description
- ğŸ–¼ **Low-poly AI-generated image** of the character
- ğŸš **5 consistent health trait sliders**
- ğŸ§ Optional name (entered by user)
- ğŸ“¤ CTA: "Copy My Archetype" â†’ converts the card to PNG and copies to clipboard

---

## ğŸ–¼ Archetype Design System

Generated by an LLM (e.g. GPT-4 or Gemini) using a structured system prompt and real health data.

**Always includes:**

- Archetype Name (max 3 words)
- Short description
- 5 key slider values (0â€“100)
- AI Image prompt (low-poly style)

---

## ğŸš The 5 Sliders (Static Dimensions)

These are the **same across all users** but each archetype reflects unique values.

| Slider               | What it captures                                      |
| -------------------- | ----------------------------------------------------- |
| Recovery Readiness   | HRV, sleep quality, rest days                         |
| Activity Load        | Exercise intensity, frequency, strain                 |
| Sleep Stability      | Sleep timing consistency, depth, wake-ups             |
| Heart Rhythm Balance | Resting heart rate vs active, variability             |
| Consistency          | Regularity across sleep, workouts, recovery behaviors |

---

## ğŸ¤– LLM Archetype Generation Prompt

Used to generate name, description, image style, and sliders. The target LLM for this prompt is `gpt-4.1-mini`.

> SYSTEM PROMPT:

```
You are a personality designer generating unique health archetypes based on biometric and lifestyle data. These are not diagnoses â€” they're symbolic digital profiles, expressed visually and narratively.

For each user, generate:

1. Archetype Name (max 3 words, title case)
2. Archetype Description: A 1â€“2 sentence summary of the person's health "vibe" and strengths
3. A low-poly image prompt: Describe a digital character in a stylized polygonal art style. Human character, geometric features, bold lighting and colors. Include scene/background. Avoid realism or animals.
4. Slider values (0â€“100) for the following 5 health traits:
   - Recovery Readiness
   - Activity Load
   - Sleep Stability
   - Heart Rhythm Balance
   - Consistency

Style references: Symbolic, expressive, vibrant low-poly avatars. No logos or brand names.
```

---

## ğŸ”— Shareability

- No URLs or persistent links
- User can **copy/download their archetype card** as an image
- Optional name appears on card
- Uses `html-to-image` or `dom-to-image` library to capture DOM node

---

## ğŸ§± Tech Stack

### Frontend

| Tool             | Purpose                            |
| ---------------- | ---------------------------------- |
| React (via Vite) | Component rendering                |
| Tailwind CSS     | Styling                            |
| Chakra UI        | Beautiful accessible UI components |
| html-to-image    | Export card as image               |

### Backend

| Tool              | Purpose                          |
| ----------------- | -------------------------------- |
| Node.js (Express) | Hosts API endpoints locally      |
| OpenAI API        | LLM + image generation           |
| In-memory JSON    | Holds session data (no database) |
| Terra API         | Pulls user health metrics        |

### Data Handling

- No persistent database
- All data is held in RAM (temporary JSON object)
- Deleted after archetype is shown

---

## ğŸ§ª Terra Data Strategy

Use Terra's standard normalized health metrics from:

- `/daily`: sleep, heart rate, activity levels
- `/activity`: workouts, intensity
- `/sleep`: detailed sleep trends
- `/body`: body comp if available
- Fetch 30â€“90 days of data

> You only need enough data to extract a stable health profile. No deep historical processing needed.

---

## ğŸ”’ Privacy & Data Ephemerality

- All processing is done in memory
- No data persisted to disk or external services
- Data wiped after archetype generation
- User sessions are non-identifiable

---

## ğŸ“ Folder Structure

This is the recommended layout for organizing the local full-stack app:

```
health-archetypes-demo/
â”‚
â”œâ”€â”€ client/                     # Frontend (React + Chakra UI)
â”‚   â”œâ”€â”€ public/                 # Static assets (favicons, index.html)
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ assets/             # Images, icons, fonts
â”‚   â”‚   â”œâ”€â”€ components/         # Reusable UI components (e.g. SliderCard, Stepper)
â”‚   â”‚   â”œâ”€â”€ pages/              # Top-level views (LandingPage, ArchetypePage)
â”‚   â”‚   â”œâ”€â”€ hooks/              # Custom React hooks (e.g. useTerraConnect, useStepper)
â”‚   â”‚   â”œâ”€â”€ utils/              # Frontend utilities (e.g. formatter, imageExport)
â”‚   â”‚   â”œâ”€â”€ theme/              # Chakra UI theme extensions
â”‚   â”‚   â”œâ”€â”€ App.tsx
â”‚   â”‚   â””â”€â”€ main.tsx
â”‚   â””â”€â”€ vite.config.ts
â”‚
â”œâ”€â”€ server/                     # Backend (Node.js + Express)
â”‚   â”œâ”€â”€ routes/                 # API route handlers (e.g. /archetype, /terra)
â”‚   â”œâ”€â”€ services/               # LLM, image gen, and Terra data handlers
â”‚   â”œâ”€â”€ utils/                  # Shared helpers (e.g. sessionManager, dataParser)
â”‚   â”œâ”€â”€ index.ts                # Express app entry point
â”‚   â””â”€â”€ types.ts                # Shared TypeScript types (for LLM prompt, etc.)
â”‚
â”œâ”€â”€ shared/                     # Common code (shared between client/server if needed)
â”‚   â””â”€â”€ constants.ts            # Shared enums, prompt strings, slider names
â”‚
â”œâ”€â”€ .env                        # API keys (OpenAI, Terra) â€“ local only
â”œâ”€â”€ package.json                # Root-level dependencies and scripts
â”œâ”€â”€ tsconfig.json               # TypeScript config
â””â”€â”€ README.md                   # Project setup and run instructions
```

---

## ğŸ“ Implementation Notes & Considerations

- **Terra API Synchronous Data Fetching:** When fetching historical data using `to_webhook=false` (to get data directly in the API response), request shorter date ranges (e.g., **28 days or less**). Longer ranges may cause Terra to respond with a "Large request submitted" message, indicating asynchronous processing which cannot be handled without a publicly accessible webhook endpoint.
- **Terra API Response Parsing:** The structure of JSON responses from Terra API endpoints (like `/daily`, `/sleep`, etc.) can vary. Ensure parsing logic (e.g., in the backend's `fetchTerraData` function) correctly handles potential nesting, typically looking for the data array within `response.data.data` or sometimes `response.data`, before defaulting to an empty array on error or unexpected structure.
- **Vite Dev Server Proxy:** When running the React frontend (Vite) and Node.js backend locally on different ports, configure Vite's `server.proxy` in `vite.config.ts` to forward API requests (e.g., `/api/*`) from the frontend to the backend server's port (e.g., `http://localhost:3000`). Remember to restart the Vite dev server after modifying the config.
- **Local Authentication Flow (No Webhooks):** The current simplified setup avoids external webhooks by having the frontend extract `user_id` from Terra's redirect URL and send it to a dedicated backend endpoint (`/api/terra/confirm-auth`) to associate it with the session ID. This relies on Terra consistently providing `user_id` in the success redirect parameters.
- **OpenAI API Key and Credits:** An OpenAI API key must be obtained from [platform.openai.com](https://platform.openai.com/) and added to the `.env` file as `OPENAI_API_KEY`. Ensure the associated OpenAI account has sufficient credits or a payment method set up, as both text and image generation API calls incur costs.
- **OpenAI Node.js Library:** The backend uses the official `openai` library (`npm install openai`) for interacting with OpenAI APIs (Chat Completions, Image Generation).
- **Environment Variable Loading (`.env`):** Ensure `dotenv.config()` is called at the **very beginning** of `server/src/index.ts`, before any other modules are imported, especially those that initialize clients or services requiring environment variables (e.g., OpenAI client). If the `.env` file is in the project root, the path for the server (running from `server/`) should be `dotenv.config({ path: '../.env' });`. Incorrect loading order or path will lead to errors like missing API keys.
- **TypeScript `unknown` Type Handling:** When fetching data from external APIs (e.g., Terra, OpenAI), the response is often typed as `unknown` after `response.json()`. To ensure type safety and prevent runtime errors, define appropriate TypeScript interfaces that model the expected API response structure. Use type assertion (e.g., `const jsonData = await response.json() as MyExpectedInterface;`) to inform TypeScript about the data's shape.
- **Port Conflict (EADDRINUSE):** If the backend server fails to start with an `EADDRINUSE` error (e.g., "address already in use :::3000"), it means another process is already using the designated port. Identify and stop the conflicting process (e.g., using `lsof -i :PORT` and `kill -9 PID` on macOS/Linux) before attempting to restart the server.

---

## âœ… MVP Milestones

### ğŸ“Š Terra Data Handling

- [X] Add API credentials to `.env` (Terra DEV_ID, API_KEY)
- [X] Implement backend logic for a local Terra widget authentication flow (no webhooks), including:
    - Session ID generation and management for the widget interaction.
    - Secure server-side call to Terra to obtain the widget session URL (embedding our `sessionId`).
    - A backend endpoint for the frontend to confirm `terraUserId` (obtained from Terra's redirect URL) against a `sessionId`, storing this mapping.
- [X] Develop backend services to:
    - Fetch a user's health data arrays (daily, sleep, activity, body) from the Terra API.
    - Package these data arrays into a unified JSON report, noting data availability.
- [X] Implement a backend mechanism to make the packaged health data report accessible via a session identifier.
- [X] Include basic fallback considerations for missing data categories in the health data report.
- [X] Implement temporary frontend page to test Terra data flow.

### ğŸ§  AI Archetype Generation

- [X] Create `/archetype` backend route
- [X] Construct system prompt (move to `shared/constants.ts`)
- [ ] Add OpenAI credentials to `.env`
- [X] Implement OpenAI call with retries + error handling
- [X] Return archetype name, description, image prompt, and sliders
- [ ] Extend frontend test page (`TerraDataViewerPage`) to call archetype generation endpoint and display LLM response.

### ğŸ–¼ Image Generation Pipeline

- [ ] Add backend call to OpenAI image endpoint with style prompt
- [ ] Stream or cache result for frontend display
- [ ] Normalize aspect ratio, resolution, and style
- [ ] Handle loading/error states gracefully on client

### ğŸ–¼ Frontend Flow â€“ Frame by Frame

#### Landing Page

- [ ] Create `LandingPage.tsx` with CTA + minimal copy
- [ ] Integrate Terra Widget launch button
- [ ] Add privacy note ("local only, session deleted")

#### Progress Stepper

- [ ] Create `Stepper.tsx` UI component with 4 labeled states
- [ ] Animate progression between steps on data fetch
- [ ] Hook stepper into backend processing stages

#### Archetype Card Display

- [ ] Create `ArchetypeCard.tsx` with:

  - Archetype name + description
  - Image (OpenAI result)
  - Sliders with labels
  - Optional name input
  - Copy/download button

### ğŸ¨ Image + Export Tools

- [ ] Implement `useImageExport()` custom hook
- [ ] Add `Copy My Archetype` CTA â†’ exports `ArchetypeCard` to PNG
- [ ] Copy to clipboard or auto-download

### ğŸ§¼ Ephemeral Data Strategy

- [ ] Store user data in temporary memory object
- [ ] Add `deleteSessionData()` after card render or timeout
- [ ] Ensure no disk writes or API logging
- [ ] Add console/session logging in dev mode only

### âœ… Polishing & Finishing Touches

- [ ] Validate all inputs and UI states
- [ ] Add animation microinteractions (e.g. Framer Motion)
- [ ] Add fallback illustrations or placeholders
- [ ] Add favicon + site meta
- [ ] Test offline behavior and session cleanups
- [ ] Write concise README with local dev instructions
